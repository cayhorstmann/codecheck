#!/bin/bash

# Copyright 2006-2012 Cay S. Horstmann
#
# This file is part of Codecheck.
#
# Codecheck is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Codecheck is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Codecheck.  If not, see <http://www.gnu.org/licenses/>.

# To test a solution, run
# codecheck grade problemdir/solution problemdir 

# To grade student homework, run
# codecheck grade submissiondir problemdir

# Here, problemdir is the directory containing the directories
# named student and grader

# This script does not modify the contents of submissiondir. 

# detect Cygwin
cygwin=false;
case "`uname`" in
  CYGWIN*) cygwin=true;
esac

linux=false
if [[ `uname` == 'Linux' ]]; then
   linux=true
fi

if [ -z "$BROWSER" ] ; then
  if $cygwin; then
    BROWSER=cygstart
  elif $linux; then
    BROWSER=xdg-open
  else
    BROWSER=open
  fi
fi

STARTDIR=`pwd`
BASEDIR=`dirname $0`
CLASSPATH="$BASEDIR/codecheck.jar"
if [ "${CLASSPATH/#\//}" == "$CLASSPATH" ] ; then CLASSPATH=`pwd`/"$CLASSPATH" ; fi

function usage() {
    echo "Usage: `basename $0` [-q] level submissiondir problemdir"
    exit
}

REPORT=report.html
JAVA_OPTS=

if [ "$1" == "-p" ] ; then BROWSER=cat ; shift ; fi

if [ "$1" == "-q" ] ; then BROWSER=echo ; shift ; fi

if [ "$1" == "-t" ] ; then 
    BROWSER=cat 
    REPORT=report.txt 
    JAVA_OPTS=-Dcom.horstmann.codecheck.textreport
    shift 
fi

LEVEL=$1
if [ -z $3 ] ; then
  # Checking solution
  SUBMISSIONDIR=`mktemp -d`
  if [ -e $2/solution ] ; then cp -R $2/solution/* $SUBMISSIONDIR ; fi
  case $LEVEL in 
    [1-9])
      for n in `seq 1 $LEVEL` ; do
        if [ -e $2/solution$n ] ; then cp -R $2/solution$n/* $SUBMISSIONDIR ; fi
      done
    ;;
    grade)
      for n in `seq 1 9` ; do
        if [ -e $2/solution$n ] ; then cp -R $2/solution$n/* $SUBMISSIONDIR ; fi
      done
      if [ -e $2/grader ] ; then cp -R $2/grader/* $SUBMISSIONDIR ; fi
    ;;
  esac  
  PROBLEMDIR=$2
else
  SUBMISSIONDIR=$2
  PROBLEMDIR=$3
  TITLE=$4
fi

if [ -z "$LEVEL" ] || [ -z "$PROBLEMDIR" ] || [ ! -d "$SUBMISSIONDIR" ] || [ ! -d "$PROBLEMDIR" ]
then
    echo $0 $@
    if [ -z "$LEVEL" ] ; then echo "No level supplied" ; fi
    if [ -z "$PROBLEMDIR" ] ; then echo "No problemdir supplied" ; fi
    if [ ! -d "$SUBMISSIONDIR" ] ; then echo "submissiondir $SUBMISSIONDIR doesn't exist" ; fi
    if [ ! -d "$PROBLEMDIR" ] ; then echo "problemdir $PROBLEMDIR doesn't exist" ; fi
    usage
fi

if [ "${SUBMISSIONDIR/#\//}" == "$SUBMISSIONDIR" ] ; then SUBMISSIONDIR=`pwd`/"$SUBMISSIONDIR" ; fi


if [ "${PROBLEMDIR/#\//}" == "$PROBLEMDIR" ] ; then PROBLEMDIR=`pwd`/"$PROBLEMDIR" ; fi

if $cygwin; then
    SUBMISSIONDIR=`cygpath -w $SUBMISSIONDIR`
    PROBLEMDIR=`cygpath -w $PROBLEMDIR`
    CLASSPATH=`cygpath -w $CLASSPATH`
fi

WORKDIR=`mktemp -d /tmp/codecheck.XXXXXXXXXX`

cd "$SUBMISSIONDIR"
REPORT_JAR=REPORT_JAR=`basename $3`.signed.zip
jar cf $REPORT_JAR .

cd "$WORKDIR"

LC_ALL=en_US.UTF-8 java -Dcom.horstmann.codecheck.language=Python $JAVA_OPTS -classpath "$CLASSPATH" com.horstmann.codecheck.Main $LEVEL "$SUBMISSIONDIR" "$PROBLEMDIR" "$TITLE"
cd - > /dev/null
$BROWSER "$SUBMISSIONDIR/$REPORT"
cd "$SUBMISSIONDIR"

if [ -e report.html ] ; then
  jar uf $REPORT_JAR report.html
  MATCH=(`grep  -o '^[<]!-- ID: \(.*\) -->$' report.html`)
  ID=${MATCH[2]}
  if [[ -n $ID ]] ; then
    mv $REPORT_JAR $ID.signed.zip
    REPORT_JAR=$ID.signed.zip
  fi
fi

jarsigner -keystore "$BASEDIR/horstmanncomodo.jks" -storepass rivu6nitt $REPORT_JAR  horstmanncomodo > /dev/null

cd $STARTDIR

if [ -z $3 ] ; then
  # Checking student files
  SUBMISSIONDIR2=`mktemp -d`
  if [ -e $2/student ] ; then 
    cd $2/student
    for f in `find .` ; do 
      cp --parents $f $SUBMISSIONDIR2
    done
    cd ../..
  fi
  case $LEVEL in 
    [1-9])
      for n in `seq 1 $LEVEL` ; do
        if [ -e $2/student$n ] ; then 
          cd $2/student$n
          for f in `find .` ; do 
            cp --parents $f $SUBMISSIONDIR2
          done
          cd ../..
        fi
      done
    ;;
  esac  

  WORKDIR=`mktemp -d /tmp/codecheck.XXXXXXXXXX`

  cd "$WORKDIR"

  if $cygwin; then
      SUBMISSIONDIR2=`cygpath -w $SUBMISSIONDIR2`
  fi

  LC_ALL=en_US.UTF-8 java -Dcom.horstmann.codecheck.language=Python $JAVA_OPTS -classpath "$CLASSPATH" com.horstmann.codecheck.Main $LEVEL "$SUBMISSIONDIR2" "$PROBLEMDIR" "$TITLE"
  cd - > /dev/null
  $BROWSER "$SUBMISSIONDIR2/$REPORT"
fi

  
